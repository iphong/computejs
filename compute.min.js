//======================================
//! ComputeJS 0.1.0
//! (c) 2013 Phong Vu, Jam.vn.
//!
//! ComputeJS may be freely distributed 
//!	under the MIT license.
//!
//! For all details and documentation:
//!	https://github.com/iphong/computejs
//======================================

void function(root){function unshift(e){var e=slice.call(e);array.unshift.apply(e,slice.call(arguments,1));return e}function each(e,t,n){if(e==null)return;if(array.forEach&&e.forEach===array.forEach){e.forEach(t,n)}else if(e.length===+e.length){for(var r=0,i=e.length;r<i;r++){if(t.call(n,e[r],r,e)==={})return}}else{for(var s in e){if(hasOwnProperty.call(e,s)){if(t.call(n,e[s],s,e)==={})return}}}}function repeat(e,t,n){var r=0;while(r++<e)t.call(n,r)}function extend(e){var e=e||{},t=slice.call(arguments,1),n;while(n=t.shift())if(n instanceof Object)for(var r in n)e[r]=n[r];return e}function defer(e,t){var n=slice.call(arguments,2);setTimeout(function(){e.apply(t,n)},0)}function inherits(e,t){PROTO_SUPPORT?t.prototype.__proto__=e.prototype:t.prototype=new e;return t}function getValue(e,t){var n,r=e;var t=t.split(".");while(n=t.shift())if(r.hasOwnProperty(n))r=r[n];else return undefined;return r}function setValue(e,t,n){if(typeof t==="object"){return each(t,function(t,n){setValue(e,n,t)})}var r,i=e;var t=t.split(".");while(r=t.shift()){i[r]||(i[r]={});t.length?i=i[r]:i[r]=n}return n}function wipe(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t)){e[t]=undefined;delete e[t]}e.__proto__=null}var window=root.window;var document=root.document;var previousCompute=root.Compute;const PROTO_SUPPORT=!Object.prototype.isPrototypeOf({__proto__:null});var array=[];var object={};var pop=array.pop;var shift=array.shift;var slice=array.slice;var splice=array.splice;var hasOwnProperty=object.hasOwnProperty;root.wipe=wipe;var path={sep:"/",delimiter:":",splitPathRe:/^(\/?)([\s\S]+\/(?!$)|\/)?((?:\.{1,2}$|[\s\S]+?)?(\.[^.\/]*)?)$/,splitPath:function(e){var t=this.splitPathRe.exec(e);return[t[1]||"",t[2]||"",t[3]||"",t[4]||""]},normalizeArray:function(e,t){var n=0;for(var r=e.length-1;r>=0;r--){var i=e[r];if(i==="."){e.splice(r,1)}else{if(i===".."){e.splice(r,1);n++}else{if(n){e.splice(r,1);n--}}}}if(t){for(;n--;n){e.unshift("..")}}return e},resolve:function(){var e="",t=false;for(var n=arguments.length-1;n>=-1&&!t;n--){var r=n>=0?arguments[n]:"/";if(typeof r!=="string"||!r){continue}e=r+"/"+e;t=r.charAt(0)==="/"}e=this.normalizeArray(e.split("/").filter(function(e){return!!e}),!t).join("/");return(t?"/":"")+e||"."},relative:function(e,t){function n(e){var t=0;for(;t<e.length;t++){if(e[t]!==""){break}}var n=e.length-1;for(;n>=0;n--){if(e[n]!==""){break}}if(t>n){return[]}return e.slice(t,n-t+1)}e=this.resolve(e).substr(1);t=this.resolve(t).substr(1);var r=n(e.split("/"));var i=n(t.split("/"));var s=Math.min(r.length,i.length);var o=s;for(var u=0;u<s;u++){if(r[u]!==i[u]){o=u;break}}var a=[];for(var u=o;u<r.length;u++){a.push("..")}a=a.concat(i.slice(o));return a.join("/")},normalize:function(e){var t=e.charAt(0)==="/",n=e.substr(-1)==="/";e=this.normalizeArray(e.split("/").filter(function(e){return!!e}),!t).join("/");if(!e&&!t){e="."}if(e&&n){e+="/"}return(t?"/":"")+e},basename:function(e,t){var n=this.splitPath(e)[2];if(t&&n.substr(-1*t.length)===t){n=n.substr(0,n.length-t.length)}return n},dirname:function(e){var t=this.splitPath(e),n=t[0],r=t[1];if(!n&&!r){return"."}if(r){r=r.substr(0,r.length-1)}return n+r},extname:function(e){return this.splitPath(e)[3]},join:function(){var e=slice(arguments);return this.normalize(e.filter(function(e,t){return e&&typeof e==="string"}).join("/"))}};var Compute=typeof exports!=="undefined"?exports:root.Compute=new function(){this.__proto__=null};Compute.version="0.1.0";Compute.noConflict=function(){root.Compute=previousCompute;return this};Compute.isMaster=function(){return window!==undefined&&document!==undefined};Compute.MAX_ERRORS=0;Compute.ERRORS_CAUGHT=0;Compute.exec=function(){var e=new Node;return e.execute.apply(e,arguments)};var EventEmitter=Compute.EventEmitter=function(){};var eventSplitter=/\s+/;var eventsApi=function(e,t,n,r){if(!n)return true;if(typeof n==="object"){for(var i in n){e[t].apply(e,[i,n[i]].concat(r))}}else if(eventSplitter.test(n)){var s=n.split(eventSplitter);for(var o=0,u=s.length;o<u;o++){e[t].apply(e,[s[o]].concat(r))}}else{return true}};var triggerEvents=function(e,t,n){var r,i=-1,s=t.length;switch(n.length){case 0:while(++i<s)(r=t[i]).callback.call(r.ctx);return;case 1:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0]);return;case 2:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1]);return;case 3:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1],n[2]);return;default:while(++i<s)(r=t[i]).callback.apply(r.ctx,n)}};var invokeEvent=function(e,t,n){each(e,function(e){EventEmitter.prototype.trigger.apply(e,unshift(n,t))})};extend(EventEmitter.prototype,{on:function(e,t,n){if(!(eventsApi(this,"on",e,[t,n])&&t))return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);r.push({callback:t,context:n,ctx:n||this});return this},off:function(e,t,n){var r,i,s,o,u,a,f,l;if(!this._events||!eventsApi(this,"off",e,[t,n]))return this;if(!e&&!t&&!n){this._events={};return this}o=e?[e]:Object.keys(this._events);for(u=0,a=o.length;u<a;u++){e=o[u];if(r=this._events[e]){s=[];if(t||n){for(f=0,l=r.length;f<l;f++){i=r[f];if(t&&t!==(i.callback._callback||i.callback)||n&&n!==i.context){s.push(i)}}}this._events[e]=s}}return this},once:function(e,t,n){if(!(eventsApi(this,"once",e,[t,n])&&t))return this;this.on(e,function r(){this.off(e,r,n);t.apply(n,arguments)},n);this._callback=t;return this},trigger:function(e){if(!this._events)return this;var t=slice.call(arguments,1);if(!eventsApi(this,"trigger",e,t))return this;var n=this._events[e];var r=this._events.all;if(n)triggerEvents(this,n,t);if(r)triggerEvents(this,r,arguments);return this},listenTo:function(e,t,n){var r=this._listeners||(this._listeners={});var i=e._listenerId||(e._listenerId=Core.uniqueID("li"));r[i]=e;e.on(t,n||this,this);return this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return;if(e){e.off(t,n,this);if(!t&&!n)delete r[e._listenerId]}else{for(var i in r){r[i].off(null,null,this)}this._listeners={}}return this}});var TaskList=Compute.TaskList=function(){this.__proto__=null};var Task=Compute.Task=inherits(EventEmitter,function(t,n){array.push.call(this,t);each(n,function(e,t){typeof e==="function"?this.done(e):array.push.call(this,e)},this)});extend(Task.prototype,{start:function(e,t){this.on("start",e,t);return this},done:function(e,t){this.on("complete",e,t);return this}});var idCounter=0;var NodeList=Compute.NodeList=function(){this.__proto__=null};var Node=Compute.Node=inherits(EventEmitter,function Compute_Node(e,t){if(!(this instanceof Compute_Node))return new Compute_Node(e,t);var n=this;var r=null;t||(t={});this.id=idCounter++;this.tasks=new TaskList;this.__defineSetter__("worker",function(e){r=e});this.__defineGetter__("worker",function(){if(!r){r=new Worker(Compute.script);r.addEventListener("message",function(e){var t=slice.call(e.data);var r=t.shift();switch(r){case"node:event":!n.active||n.active.trigger.apply(n.active,t);return n.trigger.apply(n,t);case"node:debug":return console.debug.apply(console,unshift(t,"node("+n.id+")"));case"node:warn":return console.warn.apply(console,unshift(t,"node("+n.id+")"));case"node:log":return console.log.apply(console,unshift(t,"node("+n.id+")"));case"invoke:value":case"execute:value":if(!n.active)return;invokeEvent([n.active],"complete",t);invokeEvent([n],r,unshift(t,n));n.active=null;n.next();return}});r.addEventListener("error",function(t){t.preventDefault();n.trigger("error",{lineno:t.lineno,filename:e,message:t.message,task:n.active});n.active=null;n.kill();n.next();return false});!e||r.postMessage(["node:init",e,t])}return r})});extend(Node.prototype,{emit:function(){this.worker.postMessage(unshift(arguments,"node:event"));return this},kill:function(){this.worker.terminate();this.worker=null},next:function(){if(!this.active&&this.tasks.length){this.active=array.shift.call(this.tasks);this.active.trigger("start");this.worker.postMessage(slice.call(this.active))}else if(!this.tasks.length){this.kill()}return this},push:function(e){array.push.call(this.tasks,e);this.next();return this},bind:function(e){var t=this;return setValue(this,e,function(){return t.invoke.apply(t,unshift(arguments,e))})},invoke:function(){var e=new Task("node:invoke",arguments);defer(this.push,this,e);return e},execute:function(e){var t=new Task("node:execute",unshift(slice.call(arguments,1),e.toString()));defer(this.push,this,t);return t}});var Cluster=Compute.Cluster=inherits(Node,function Compute_Cluster(e,t,n){if(!(this instanceof Compute_Cluster))return new Compute_Cluster(e,t,n);if(typeof t=="object")var n=t,t=1;this.filename=e;this.options=n;this.nodes=new NodeList;this.tasks=new TaskList;this.fork(t)});extend(Cluster.prototype,{fork:function(e){typeof e=="number"||(e=1);while(e--){void function(e){e.cluster=this;e.tasks=this.tasks;array.push.call(this.nodes,e);e.on("all",function(t){this.trigger.apply(this,unshift(slice.call(arguments,1),t,e))},this)}.call(this,new Node(this.filename,this.options))}return this},node:function(e){return array.filter.call(this.nodes,function(t){return t.id==e})[0]},emit:function(){each(this.nodes,function(e){e.emit.apply(e,this)},arguments);return this},next:function(){each(this.nodes,function(e){e.next()});return this}});var Context=Compute.Context=inherits(EventEmitter,function Compute_Context(e){if(!(this instanceof Compute_Context))return new Compute_Context;this.exports={};this.filename=e||location.pathname});var Module=Compute.Module=inherits(EventEmitter,function Compute_Module(e,t,n){if(!(this instanceof Compute_Module))return new Compute_Module(e,t,n);this.filename=e;this.module=this;this.parent=t;this.exports={};var r=new XMLHttpRequest;r.open("GET",e,false);r.send();var i=r.status===200?r.response:null;var s="with (global) { with(scope) { eval(source); } }";var n=this.scope=n||{};Function("global","scope","source","__dirname",s).call(root,this,n,i,path.dirname(e));return this.exports});extend(Module.prototype,{__proto__:null,require:function(e){var e=path.resolve(path.dirname(this.parent.filename),e);return Module(e,this,this.scope)}});switch(Compute.isMaster()){case true:Compute.script=array.pop.call(document.querySelectorAll("script")).getAttribute("src");require=function(e){return new Module(e,new Context(Compute.script),{})};break;case false:var node=root.node=new Context(location.pathname);root.require=node.require=function(e){return Module(e,node,node.scope)};root.emit=node.emit=function(){postMessage(unshift(arguments,"node:event"))};root.log=node.log=function(){postMessage(unshift(arguments,"node:log"))};root.debug=node.debug=function(){postMessage(unshift(arguments,"node:debug"))};root.warn=node.warn=function(){postMessage(unshift(arguments,"node:warn"))};root.addEventListener("message",function(event){var args=slice.call(event.data);var type=args.shift();switch(type){case"node:init":var filename=args.shift();var options=args.shift();node.scope=options.scope||{};node.exports=require(path.resolve(path.dirname(node.filename),filename));break;case"node:event":node.trigger.apply(node,args);break;case"node:invoke":var func=getValue(node.exports,args.shift());node.once("invoke:value",function(){postMessage(unshift(arguments,"invoke:value"))});args.push(node.trigger.bind(node,"invoke:value"));if(typeof func==="function"){var result=func.apply(node,args);if(result!==undefined)node.trigger("invoke:value",result)}break;case"node:execute":eval("var func = "+args.shift());node.once("execute:value",function(){postMessage(unshift(arguments,"execute:value"))});args.push(node.trigger.bind(node,"execute:value"));var result=func.apply(node,args);if(result!==undefined)node.trigger("execute:value",result);break}},true);break}}(this)